<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map Editor</title>
  <style>
    body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: -apple-system, system-ui, sans-serif; overflow: hidden; background: #0f172a; color: #f8fafc; }
    #toolbar { background: #1e293b; border-bottom: 1px solid #334155; padding: 8px; display: flex; gap: 12px; align-items: center; z-index: 10; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
    #toolbar::-webkit-scrollbar { display: none; }
    .tool-section { display: flex; align-items: center; gap: 8px; border-right: 1px solid #475569; padding-right: 12px; flex-shrink: 0; }
    .palette { display: flex; gap: 4px; align-items: center; flex-shrink: 0; }
    .label { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.05em; }
    button { background: #334155; border: 1px solid #475569; color: #e2e8f0; padding: 8px 12px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; white-space: nowrap; touch-action: manipulation; min-height: 38px; }
    button:hover { background: #475569; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; align-items:center; justify-content:center; }
    .modal-content { background:#1e293b; padding:20px; border-radius:8px; width:320px; display:flex; flex-direction:column; gap:12px; border: 1px solid #334155; }
    .modal-content h3 { margin: 0 0 8px 0; font-size: 16px; }
    .modal-content input { background: #0f172a; color: white; border: 1px solid #475569; border-radius: 4px; padding: 8px; outline: none; }
    button.active { background: #2563eb; border-color: #3b82f6; color: white; }
    #viewport { flex-grow: 1; position: relative; overflow: hidden; }
    canvas { display: block; touch-action: none; }
    .swatch { width: 12px; height: 12px; border: 1px solid rgba(0,0,0,0.3); border-radius: 2px; }
    #status { position: fixed; bottom: 16px; right: 16px; background: rgba(15, 23, 42, 0.9); padding: 4px 12px; border-radius: 100px; font-size: 12px; color: #94a3b8; border: 1px solid #334155; pointer-events: none; }
  </style>
</head>
<body>
  <div id="toolbar">
    <div class="tool-section">
      <span class="label">Mode</span>
      <button id="tool-pan">Pan</button>
      <button id="tool-pen">Tiles</button>
      <button id="tool-zone">Zones</button>
      <button id="tool-toggle-zones">View</button>
    </div>
    <div class="tool-section">
      <span class="label">Maps</span>
      <select id="map-select" style="background: #334155; color: white; border: 1px solid #475569; border-radius: 4px; padding: 4px; width: 80px;"></select>
      <button id="btn-new">+</button>
      <button id="btn-export">Exp</button>
    </div>
    <div class="tool-section">
      <span class="label">Zone ID</span>
      <input type="number" id="zone-id" value="1" min="0" max="99" style="width: 40px; background: #334155; color: white; border: 1px solid #475569; border-radius: 4px; padding: 4px; outline: none;">
    </div>
    <div class="tool-section">
      <span class="label">Sync</span>
      <button id="btn-settings">Cfg</button>
      <button id="btn-import">Imp</button>
    </div>
    <div class="palette" id="palette">
      <span class="label">Tiles</span>
    </div>
  </div>
  <div id="viewport">
    <canvas id="editorCanvas"></canvas>
  </div>
  <div id="status">X: 0, Y: 0</div>
  <div id="modal-export" class="modal">
    <div class="modal-content" style="width: 80%; max-width: 600px;">
      <h3>Export Data</h3>
      <textarea id="export-output" style="height: 300px; background: #0f172a; color: #10b981; border: 1px solid #475569; border-radius: 4px; padding: 8px; font-family: monospace; font-size: 11px;"></textarea>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="export-copy" style="flex:1; justify-content:center;">Copy to Clipboard</button>
        <button id="export-close" style="flex:1; justify-content:center; background:#475569;">Close</button>
      </div>
    </div>
  </div>
  <div id="modal-settings" class="modal">
    <div class="modal-content">
      <h3>GitHub Settings</h3>
      <label class="label">API Key</label>
      <input type="password" id="gh-token" placeholder="Optional token">
      <label class="label">Repo (owner/repo)</label>
      <input type="text" id="gh-repo" placeholder="e.g. user/repo">
      <label class="label">File Path</label>
      <input type="text" id="gh-path" placeholder="e.g. index.html">
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="gh-save" style="flex:1; justify-content:center;">Save</button>
        <button id="gh-close" style="flex:1; justify-content:center; background:#475569;">Close</button>
      </div>
    </div>
  </div>
  <script>
    const canvas = document.getElementById('editorCanvas');
    const ctx = canvas.getContext('2d');
    const palette = document.getElementById('palette');
    const status = document.getElementById('status');
    const TILE_SIZE = 32;
    const TILES = {
      'T': { type: 'tree', color: '#064e3b' },
      ' ': { type: 'grass', color: '#2ecc71' },
      'D': { type: 'dirt', color: '#d35400' },
      'f': { type: 'dungeon', color: '#1b5e20' },
      'm': { type: 'dungeon', color: '#7f8c8d' },
      's': { type: 'dungeon', color: '#f1c40f' },
      'W': { type: 'water', color: '#3498db' },
      'b': { type: 'boulder', color: '#475569' }
    };
    let allMaps = { "map1": { layout: Array.from({ length: 60 }, () => ' '.repeat(60)), encounters: Array.from({ length: 60 }, () => Array(60).fill(0)) } };
    let currentKey = "map1";
    let MAP_SIZE = 60;
    let mapData = allMaps[currentKey].layout;
    let zoneData = allMaps[currentKey].encounters;
    let cam = { x: 50, y: 50 };
    let mode = 'pen';
    let brush = ' ';
    let activeZone = 1;
    let isDown = false;
    let lastPos = { x: 0, y: 0 };
    let showZones = false;
    let ghConfig = JSON.parse(localStorage.getItem('map_editor_gh') || '{"token":"","repo":"","path":""}');

    function openSettings() {
      document.getElementById('gh-token').value = ghConfig.token || '';
      document.getElementById('gh-repo').value = ghConfig.repo || '';
      document.getElementById('gh-path').value = ghConfig.path || '';
      document.getElementById('modal-settings').style.display = 'flex';
    }

    function saveSettings() {
      ghConfig.token = document.getElementById('gh-token').value;
      ghConfig.repo = document.getElementById('gh-repo').value;
      ghConfig.path = document.getElementById('gh-path').value;
      localStorage.setItem('map_editor_gh', JSON.stringify(ghConfig));
      document.getElementById('modal-settings').style.display = 'none';
    }

    async function importFromGithub() {
      if (!ghConfig.repo || !ghConfig.path) return alert("Please configure GitHub settings.");
      const url = `https://api.github.com/repos/${ghConfig.repo}/contents/${ghConfig.path}`;
      const headers = { 'Accept': 'application/vnd.github.v3.raw' };
      if (ghConfig.token) headers['Authorization'] = `token ${ghConfig.token}`;
      try {
        const res = await fetch(url, { headers });
        if (!res.ok) throw new Error(`GitHub API error: ${res.status}`);
        const content = await res.text();
        const match = content.match(/MAP_DATA\\s*=\\s*([\\s\\S]+?)(?=;|\\n\\s*<\\/script>)/);
        if (!match) throw new Error("MAP_DATA variable not found in file.");
        const maps = new Function(`return ${match[1].trim()}`)();
        const names = Object.keys(maps);
        if (names.length === 0) throw new Error("No maps found in MAP_DATA.");
        const selected = names.length === 1 ? names[0] : prompt("Select map to import (or all):\\n" + names.join(", "), names[0]);
        if (selected && maps[selected]) {
          Object.assign(allMaps, maps);
          selectMap(selected);
          saveToStorage();
          alert(`Imported ${names.length} maps.`);
        }
      } catch (e) { alert("Import failed: " + e.message); } 
    }

    function exportMaps() {
      const output = "const MAP_DATA = " + JSON.stringify(allMaps, null, 2) + ";";
      document.getElementById('export-output').value = output;
      document.getElementById('modal-export').style.display = 'flex';
    }

    function saveToStorage() {
      localStorage.setItem('map_editor_all_maps', JSON.stringify({ allMaps, currentKey }));
    }

    function loadFromStorage() {
      const saved = localStorage.getItem('map_editor_all_maps');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (data.allMaps) {
            allMaps = data.allMaps;
            selectMap(data.currentKey || Object.keys(allMaps)[0]);
          }
        } catch (e) { console.error("Load error", e); }
      } else {
        const old = localStorage.getItem('map_editor_save');
        if (old) {
          try {
            const data = JSON.parse(old);
            if (data.mapData) {
               allMaps = { "imported": { layout: data.mapData, encounters: data.zoneData || data.mapData.map(r => Array(r.length).fill(0)) } };
               selectMap("imported");
            }
          } catch(e) {}
        }
      }
      updateMapSelector();
    }

    function updateMapSelector() {
      const sel = document.getElementById('map-select');
      sel.innerHTML = '';
      Object.keys(allMaps).forEach(k => {
        const opt = document.createElement('option');
        opt.value = k; opt.innerText = k; opt.selected = (k === currentKey);
        sel.appendChild(opt);
      });
    }

    function selectMap(key) {
      if (!allMaps[key]) return;
      currentKey = key;
      mapData = allMaps[key].layout;
      zoneData = allMaps[key].encounters;
      MAP_SIZE = mapData.length;
      updateMapSelector();
    }

    function newMap() {
      const name = prompt("Map name?", "map" + (Object.keys(allMaps).length + 1));
      if (!name || allMaps[name]) return;
      const size = parseInt(prompt("Size (10-200)?", "60")) || 60;
      allMaps[name] = {
        layout: Array.from({ length: size }, () => ' '.repeat(size)),
        encounters: Array.from({ length: size }, () => Array(size).fill(0))
      };
      selectMap(name);
      saveToStorage();
    }

    function init() {
      loadFromStorage();
      Object.entries(TILES).forEach(([char, cfg]) => {
        const b = document.createElement('button');
        b.innerHTML = `<div class="swatch" style="background:${cfg.color}"></div>${cfg.type}`;
        b.onclick = (e) => { e.preventDefault(); brush = char; setMode('pen'); };
        b.dataset.char = char;
        palette.appendChild(b);
      });
      document.getElementById('tool-pan').onclick = () => setMode('pan');
      document.getElementById('tool-pen').onclick = () => setMode('pen');
      document.getElementById('tool-zone').onclick = () => setMode('zone');
      document.getElementById('tool-toggle-zones').onclick = () => {
        showZones = !showZones;
        document.getElementById('tool-toggle-zones').classList.toggle('active', showZones);
      };
      document.getElementById('map-select').onchange = (e) => selectMap(e.target.value);
      document.getElementById('btn-new').onclick = newMap;
      document.getElementById('btn-export').onclick = exportMaps;
      document.getElementById('zone-id').onchange = (e) => activeZone = parseInt(e.target.value) || 0;
      document.getElementById('btn-settings').onclick = openSettings;
      document.getElementById('btn-import').onclick = importFromGithub;
      document.getElementById('gh-save').onclick = saveSettings;
      document.getElementById('gh-close').onclick = () => document.getElementById('modal-settings').style.display = 'none';
      document.getElementById('export-close').onclick = () => document.getElementById('modal-export').style.display = 'none';
      document.getElementById('export-copy').onclick = () => {
        document.getElementById('export-output').select();
        document.execCommand('copy');
        alert('Copied to clipboard');
      };
      window.addEventListener('resize', resize);
      const handleStart = (e) => {
        isDown = true;
        const p = e.touches ? e.touches[0] : e;
        lastPos = { x: p.clientX, y: p.clientY };
        if (mode !== 'pan') paint(p.clientX, p.clientY);
      };
      const handleMove = (e) => {
        const p = e.touches ? e.touches[0] : e;
        const rect = canvas.getBoundingClientRect();
        const mx = Math.floor((p.clientX - rect.left - cam.x) / TILE_SIZE);
        const my = Math.floor((p.clientY - rect.top - cam.y) / TILE_SIZE);
        if (mx >= 0 && mx < MAP_SIZE && my >= 0 && my < MAP_SIZE) status.innerText = `X: ${mx}, Y: ${my} [${currentKey}]`;
        if (!isDown) return;
        if (mode === 'pan') {
          cam.x += p.clientX - lastPos.x;
          cam.y += p.clientY - lastPos.y;
        } else paint(p.clientX, p.clientY);
        lastPos = { x: p.clientX, y: p.clientY };
      };
      const handleEnd = () => isDown = false;
      canvas.addEventListener('mousedown', handleStart);
      canvas.addEventListener('touchstart', handleStart, { passive: false });
      window.addEventListener('mousemove', handleMove);
      window.addEventListener('touchmove', handleMove, { passive: false });
      window.addEventListener('mouseup', handleEnd);
      window.addEventListener('touchend', handleEnd);
      window.addEventListener('touchcancel', handleEnd);
      resize();
      setMode('pen');
      render();
    }

    function setMode(m) {
      mode = m;
      document.getElementById('tool-pan').classList.toggle('active', mode === 'pan');
      document.getElementById('tool-pen').classList.toggle('active', mode === 'pen');
      document.getElementById('tool-zone').classList.toggle('active', mode === 'zone');
      Array.from(palette.getElementsByTagName('button')).forEach(b => {
        b.classList.toggle('active', mode === 'pen' && b.dataset.char === brush);
      });
      canvas.style.cursor = mode === 'pan' ? 'grab' : (mode === 'zone' ? 'cell' : 'crosshair');
    }

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight - document.getElementById('toolbar').offsetHeight;
    }

    function paint(ex, ey) {
      const rect = canvas.getBoundingClientRect();
      const tx = Math.floor((ex - rect.left - cam.x) / TILE_SIZE);
      const ty = Math.floor((ey - rect.top - cam.y) / TILE_SIZE);
      if (tx >= 0 && tx < MAP_SIZE && ty >= 0 && ty < MAP_SIZE) {
        let changed = false;
        if (mode === 'pen') {
          const row = mapData[ty];
          if (row[tx] !== brush) {
            mapData[ty] = row.substring(0, tx) + brush + row.substring(tx + 1);
            changed = true;
          }
        } else if (mode === 'zone') {
          if (zoneData[ty][tx] !== activeZone) {
            zoneData[ty][tx] = activeZone;
            changed = true;
          }
        }
        if (changed) saveToStorage();
      }
    }

    function render() {
      ctx.fillStyle = '#0f172a';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(cam.x, cam.y);
      const vX0 = Math.max(0, Math.floor(-cam.x / TILE_SIZE));
      const vX1 = Math.min(MAP_SIZE, Math.ceil((canvas.width - cam.x) / TILE_SIZE));
      const vY0 = Math.max(0, Math.floor(-cam.y / TILE_SIZE));
      const vY1 = Math.min(MAP_SIZE, Math.ceil((canvas.height - cam.y) / TILE_SIZE));
      ctx.fillStyle = '#1e293b';
      ctx.fillRect(0, 0, MAP_SIZE * TILE_SIZE, MAP_SIZE * TILE_SIZE);
      for (let y = vY0; y < vY1; y++) {
        for (let x = vX0; x < vX1; x++) {
          const char = mapData[y] ? (mapData[y][x] || ' ') : ' ';
          const cfg = TILES[char] || TILES[' '];
          ctx.fillStyle = cfg.color;
          ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
          const zid = zoneData[y] ? zoneData[y][x] : 0;
          if (zid > 0 && (showZones || mode === 'zone')) {
            ctx.fillStyle = 'white';
            ctx.shadowBlur = 3;
            ctx.shadowColor = 'black';
            ctx.font = 'bold 11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(zid, x * TILE_SIZE + TILE_SIZE/2, y * TILE_SIZE + TILE_SIZE/2 + 4);
            ctx.shadowBlur = 0;
          }
          ctx.strokeStyle = 'rgba(0,0,0,0.1)';
          ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
        }
      }
      ctx.restore();
      requestAnimationFrame(render);
    }
    init();
  </script>
</body>
</html>