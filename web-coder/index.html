<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Web Coder</title>
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border-color: #3f3f46;
            --danger-color: #ef4444;
            --success-color: #22c55e;
            --header-height: 60px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100dvh;
            overflow: hidden; /* App-like feel */
            display: flex;
            flex-direction: column;
        }

        /* Layout & Views */
        main {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
            position: relative;
            width: 100%;
            max-width: 600px; /* Tablet/Desktop constraint */
            margin: 0 auto;
        }

        .view {
            display: none;
            padding: var(--spacing-md);
            padding-bottom: 80px; /* Space for potential FABs or scrolling */
            animation: fadeIn 0.2s ease-out;
        }

        .view.active {
            display: flex;
            flex-direction: column;
            flex: 1;
            /* Ensure width constraints are kept for non-editor views */
            width: 100%; 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Headers */
        .app-header {
            height: var(--header-height);
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Forms & Inputs */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--primary-color);
        }

        .help-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 6px;
            line-height: 1.4;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:active {
            background-color: var(--primary-hover);
        }

        /* Cards (Upcoming usage) */
        .card {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        /* Editor Layout */
        .editor-layout {
            display: flex;
            flex-direction: column;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        /* Update: Editor header doesn't need to be sticky if the container doesn't scroll. 
           It is a flex item now. We remove sticky to prevent z-index context issues. */
        .editor-layout .app-header {
            /* Add padding for the notch, fallback to 10px */
            padding-top: max(10px, env(safe-area-inset-top)); 
            height: auto;
            min-height: var(--header-height);
            /* Ensure content is centered vertically considering the new top padding */
            padding-bottom: 10px;
            align-items: flex-end; 
        }
        
        /* Adjust icons/text inside the taller header */
        .editor-layout .app-header > * {
            margin-bottom: 5px;
        }

        /* Tabs */
        .tab-nav {
            display: flex;
            background: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Editor Content Areas */
        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
            position: relative;
            min-height: 0; /* Allow tab content to shrink and enable child scrolling */
        }
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* AI Chat UI */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 85%;
            padding: 12px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .message.ai {
            align-self: flex-start;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-bottom-left-radius: 2px;
        }
        
        .message.system {
            align-self: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .message-actions {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: flex-end;
        }

        .btn-xs {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: rgba(0,0,0,0.2);
            color: var(--text-secondary);
        }
        .btn-xs:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }

        .chat-input-area {
            padding: var(--spacing-md);
            background-color: var(--surface-color);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .model-selector {
            padding: 8px;
            background: var(--bg-color);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.8rem;
        }

        /* Review Modal Styles */
        .operation-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .operation-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .operation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        .operation-header label {
            margin-bottom: 0;
            flex-grow: 1;
        }
        .diff-view {
            font-family: monospace;
            font-size: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            margin-top: 10px;
            overflow-x: auto; /* Allow horizontal scrolling */
        }
        .diff-view pre {
            padding: 8px;
            margin: 0;
            line-height: 1.3;
            white-space: pre; /* Prevent wrapping to enable scroll */
        }
        .diff-view .removed {
            background-color: rgba(239, 68, 68, 0.1);
        }
        .diff-view .added {
            background-color: rgba(34, 197, 94, 0.1);
        }

        .diff-summary {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success-color);
            padding: 10px;
            border-radius: var(--radius);
            margin-top: 10px;
        }

        /* Manual Code Editor */
        .code-editor-container {
            display: flex;
            flex: 1;
            background-color: #1e1e1e;
            overflow: hidden;
            position: relative;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
        }

        .line-numbers {
            background-color: #252526;
            color: #858585;
            padding: 10px 5px;
            text-align: right;
            border-right: 1px solid #333;
            user-select: none;
            overflow: hidden;
            width: 45px;
            line-height: 1.5;
        }

        .code-area {
            flex: 1;
            background-color: #1e1e1e;
            color: #d4d4d4;
            border: none;
            resize: none;
            padding: 10px;
            white-space: pre;
            overflow: auto;
            outline: none;
            line-height: 1.5;
            tab-size: 2;
        }

        /* Preview Iframe */
        iframe.preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white; /* Web pages usually expect white bg */
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary-color);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Utilities */
        .hidden { display: none !important; }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            cursor: pointer;
            border: none;
            font-size: 24px;
            transition: transform 0.2s;
            z-index: 90;
        }
        .fab:active { transform: scale(0.95); }

        /* Project List */
        .project-list {
            padding-bottom: 80px;
        }
        
        .project-card {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .project-info h3 {
            font-size: 1rem;
            margin-bottom: 4px;
            color: var(--text-primary);
        }
        
        .project-info p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .project-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 8px;
            cursor: pointer;
            font-size: 1.1rem;
        }
        .icon-btn:hover { color: var(--text-primary); }
        .icon-btn.danger { color: var(--danger-color); }

        /* Header Actions */
        .header-actions {
            position: absolute;
            right: var(--spacing-md);
            display: flex;
            gap: 8px;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.7);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            backdrop-filter: blur(2px);
        }
        
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: var(--surface-color);
            width: 90%;
            max-width: 400px;
            padding: var(--spacing-lg);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            transform: translateY(20px);
            transition: transform 0.2s;
        }

        .modal-overlay.open .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: var(--spacing-md);
            display: flex;
            justify-content: space-between;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: var(--spacing-lg);
        }
        
        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            pointer-events: none;
            width: 90%;
            max-width: 400px;
        }
        
        .toast {
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            margin-top: 10px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show { opacity: 1; }

        /* Manual Selection Styles */
        #modal-manual-select { z-index: 250; }
        .manual-select-layout {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            gap: 15px;
            margin-top: 10px;
        }
        .navigator-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            overflow: hidden;
        }
        #manual-line-navigator {
            flex: 1;
            overflow-y: auto;
        }
        .line-row {
            display: flex;
            font-family: monospace;
            font-size: 0.75rem;
            cursor: pointer;
            line-height: 1.2rem;
            border-bottom: 1px solid rgba(255,255,255,0.02);
        }
        .line-row:hover { background: rgba(255,255,255,0.05); }
        .line-row.selected { background: rgba(59, 130, 246, 0.4); }
        .line-row.match { background: rgba(255, 255, 0, 0.15); }
        .line-num-nav {
            width: 40px;
            text-align: right;
            padding-right: 8px;
            background: #252526;
            color: #858585;
            user-select: none;
            border-right: 1px solid #333;
        }
        .line-content-nav {
            padding-left: 8px;
            white-space: pre;
            color: #d4d4d4;
        }
    </style>
</head>
<body>

    <!-- App Header -->
    <header class="app-header">
        <span class="header-title">Web Coder</span>
    </header>

    <main id="app">
        
        <!-- SCREEN: SETUP -->
        <section id="screen-setup" class="view active">
            <div class="card" style="margin-bottom: 30px;">
                <h2 style="margin-bottom: 10px; font-size: 1.1rem;">Configuration</h2>
                <p class="help-text" style="margin-bottom: 0;">
                    Your keys are stored locally on your device.
                </p>
            </div>

            <form id="setup-form">
                <!-- GitHub Config -->
                <div class="form-group">
                    <label for="gh-token">GitHub Personal Access Token</label>
                    <input type="password" id="gh-token" placeholder="ghp_..." autocomplete="off">
                    <div class="help-text">
                        Must have <code>repo</code> scope permissions. 
                        <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--primary-color)">Generate here</a>.
                    </div>
                </div>

                <div class="form-group">
                    <label for="gh-repo">GitHub Repository (owner/repo)</label>
                    <input type="text" id="gh-repo" placeholder="username/repository" autocomplete="off">
                </div>

                <!-- Google AI Config -->
                <div class="form-group">
                    <label for="ai-key">Google AI Studio API Key</label>
                    <input type="password" id="ai-key" placeholder="AIza..." autocomplete="off">
                    <div class="help-text">
                        Required for AI coding assistance.
                        <a href="https://aistudio.google.com/" target="_blank" style="color: var(--primary-color)">Get key here</a>.
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Save Configuration</button>
            </form>
        </section>

        <!-- SCREEN: PROJECTS VIEW -->
        <section id="screen-projects" class="view">
            <!-- Custom Header for Projects specific view -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 1.2rem;">My Projects</h2>
                <div>
                    <button class="icon-btn" id="btn-import-export" title="Import/Export">‚áÑ</button>
                    <button class="icon-btn" id="btn-settings" title="Settings">‚öôÔ∏è</button>
                </div>
            </div>

            <div id="project-list-container" class="project-list">
                <!-- Projects injected here via JS -->
            </div>

            <div style="text-align: center; color: var(--text-secondary); margin-top: 40px;" id="empty-state" class="hidden">
                <p>No projects found.</p>
                <p style="font-size: 0.9rem">Tap + to add a GitHub repository.</p>
            </div>

            <button class="fab" id="btn-add-project">+</button>
        </section>

        <!-- MODAL: Add Project -->
        <div id="modal-add-project" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">New Project</div>
                <form id="form-add-project">
                    <div class="form-group">
                        <label>Project Name (Folder Name)</label>
                        <input type="text" id="inp-proj-name" required placeholder="e.g. landing-page">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn" style="background:transparent; border:1px solid var(--border-color); color: var(--text-primary)" onclick="App.closeModals()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL: Review AI Changes -->
        <div id="modal-review" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">Review AI Changes</div>
                <div id="review-operations-list" style="max-height: 60vh; overflow-y: auto;">
                    <!-- Operations will be injected here -->
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" style="background:transparent; border:1px solid var(--border-color); color: var(--text-primary)" onclick="App.closeModals()">Cancel</button>
                    <button type="button" id="btn-apply-selected" class="btn btn-primary">Apply Selected</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Manual Selection -->
        <div id="modal-manual-select" class="modal-overlay">
            <div class="modal-content" style="max-width: 900px; width: 95%; height: 95vh; display: flex; flex-direction: column;">
                <div class="modal-header">Manual Line Selection</div>
                <p class="help-text">The AI's search string wasn't found. Select lines in your file that should be removed and replaced by the AI output.</p>
                
                <div class="manual-select-layout">
                    <!-- Top: AI Context -->
                    <div style="display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; max-height: 40%;">
                        <div style="display: flex; gap: 10px; flex: 1; overflow: hidden;">
                            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 2px;">AI Intended to Replace:</div>
                                <div class="diff-view" style="flex: 1; overflow: auto; background: #1a1a1a;">
                                    <pre class="removed" id="manual-ai-search-view" style="font-size: 0.7rem;"></pre>
                                </div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 2px;">Replacement:</div>
                                <div class="diff-view" style="flex: 1; overflow: auto; background: #1a1a1a;">
                                    <pre class="added" id="manual-ai-replace-view" style="font-size: 0.7rem;"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bottom: Navigator -->
                    <div class="navigator-pane">
                        <div style="padding: 10px; border-bottom: 1px solid var(--border-color); background: var(--surface-color);">
                            <input type="text" id="manual-line-search" placeholder="Search code to navigate..." style="padding: 8px; font-size: 0.8rem;">
                        </div>
                        <div id="manual-line-navigator"></div>
                    </div>
                </div>

                <div class="modal-actions">
                    <div id="selection-status" style="flex: 1; font-size: 0.8rem; color: var(--text-secondary); align-self: center;"></div>
                    <button type="button" class="btn" style="width:auto; background:transparent; border:1px solid var(--border-color); color: var(--text-primary)" onclick="App.closeManualSelect()">Cancel</button>
                    <button type="button" id="btn-apply-manual" class="btn btn-primary" style="width: auto;" disabled>Replace Selected</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Delete Confirmation -->
        <div id="modal-delete-confirm" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">Delete Project?</div>
                <p>Are you sure you want to remove this project from Web Coder? This will not affect the GitHub repository.</p>
                <div class="modal-actions">
                    <button type="button" class="btn" style="background:transparent; border:1px solid var(--border-color); color: var(--text-primary)" onclick="App.closeModals()">Cancel</button>
                    <button type="button" id="btn-confirm-delete" class="btn" style="background-color: var(--danger-color); color: white;">Delete</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Import/Export -->
        <div id="modal-io" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">Data Management</div>
                <p style="margin-bottom: 15px; color: var(--text-secondary);">Backup or restore your project list JSON.</p>
                
                <button id="btn-download-json" class="btn btn-primary" style="margin-bottom: 10px;">Download Projects JSON</button>
                
                <div style="position: relative; overflow: hidden; margin-top: 10px;">
                    <button class="btn" style="background: var(--surface-color); border: 1px solid var(--border-color);">Import JSON File</button>
                    <input type="file" id="inp-import-json" accept=".json" style="position: absolute; top:0; left:0; opacity: 0; width: 100%; height: 100%; cursor: pointer;">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn" style="background:transparent; border:1px solid var(--border-color); color: var(--text-primary)" onclick="App.closeModals()">Close</button>
                </div>
            </div>
        </div>

        <!-- SCREEN: PROJECT EDITOR -->
        <section id="screen-editor" class="view" style="padding: 0; max-width: none;">
            <div class="editor-layout">
                <!-- Sticky Editor Header -->
                <div class="app-header" style="justify-content: space-between; padding: 0 15px;">
                    <button class="icon-btn" onclick="App.navigateTo('projects')">‚Üê</button>
                    <span id="editor-title" style="font-size: 1rem;">Project Name</span>
                    <button class="icon-btn" id="btn-save-trigger" style="color: var(--success-color); font-weight:bold;">Save</button>
                </div>

                <!-- Tabs -->
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="App.switchTab('ai')">AI Coder</button>
                    <button class="tab-btn" onclick="App.switchTab('preview')">Preview</button>
                    <button class="tab-btn" onclick="App.switchTab('manual')" style="opacity: 0.5;">Code</button>
                </div>

                <!-- Tab: AI Coder -->
                <div id="tab-ai" class="tab-content active">
                    <div id="chat-history" class="chat-container">
                        <div class="message system">Welcome. Select a model and describe your changes.</div>
                    </div>
                    
                    <div class="chat-input-area">
                        <select id="model-select" class="model-selector">
                            <option value="gemini-3-pro-preview">Gemini 3 Pro Preview</option>
                            <option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
                            <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                            <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
                        </select>
                        <div style="display:flex; gap: 8px;">
                            <textarea id="ai-prompt" rows="2" placeholder="e.g., Change the background to blue..." style="resize:none;"></textarea>
                            <button id="btn-send-prompt" class="btn btn-primary" style="width: auto;">
                                <span>‚û§</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Preview -->
                <div id="tab-preview" class="tab-content">
                    <iframe id="preview-frame" class="preview-frame"></iframe>
                </div>

                <!-- Tab: Manual Code Editor -->
                <div id="tab-manual" class="tab-content">
                    <div class="code-editor-container">
                        <div id="line-numbers" class="line-numbers">1</div>
                        <textarea id="manual-code-area" class="code-area" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
                    </div>
                </div>
            </div>
        </section>

        <!-- MODAL: Commit Changes -->
        <div id="modal-commit" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">Commit Changes</div>
                <form id="form-commit">
                    <div class="form-group">
                        <label>Commit Message</label>
                        <textarea id="commit-msg" rows="3" required></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn" style="background:transparent; border:1px solid var(--border-color); color: var(--text-primary)" onclick="App.closeModals()">Cancel</button>
                        <button type="submit" id="btn-push" class="btn btn-primary">Push to GitHub</button>
                    </div>
                </form>
            </div>
        </div>

    </main>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        /**
         * GitHub API Helper
         */
        const GitHubAPI = {
            baseUrl: 'https://api.github.com',
            
            async getFile(token, owner, repo, path) {
                const url = `${this.baseUrl}/repos/${owner}/${repo}/contents/${path}`;
                const response = await fetch(url, {
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (response.status === 404) return { content: '', sha: null };
                if (!response.ok) throw new Error('Failed to fetch file');
                const data = await response.json();
                const content = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
                return { content, sha: data.sha };
            },

            async getContents(token, owner, repo, path = '') {
                const url = `${this.baseUrl}/repos/${owner}/${repo}/contents/${path}`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (!response.ok) throw new Error('Failed to fetch contents');
                return await response.json();
            },

            async deleteFile(token, owner, repo, path, sha, message) {
                const url = `${this.baseUrl}/repos/${owner}/${repo}/contents/${path}`;
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, sha })
                });
                if (!response.ok) throw new Error('Failed to delete file');
                return await response.json();
            },

            async updateFile(token, owner, repo, path, content, sha, message) {
                const url = `${this.baseUrl}/repos/${owner}/${repo}/contents/${path}`;
                const encoded = btoa(new TextEncoder().encode(content).reduce((data, byte) => data + String.fromCharCode(byte), ''));
                const payload = { message, content: encoded };
                if (sha) payload.sha = sha;
                const response = await fetch(url, { method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error('Failed to push commit');
                return await response.json();
            }
        };

        /**
         * Google AI Helper
         */
        const GoogleAI = {
            baseUrl: 'https://generativelanguage.googleapis.com/v1beta',

            // Define the schema for the Diff format
            schema: {
                type: "OBJECT",
                properties: {
                    commit_message: { type: "STRING" },
                    operations: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                type: { type: "STRING", enum: ["replace"] },
                                search_string: { type: "STRING" },
                                replacement_string: { type: "STRING" }
                            },
                            required: ["type", "search_string", "replacement_string"]
                        }
                    }
                },
                required: ["commit_message", "operations"]
            },

            async listModels(apiKey) {
                // ... (no changes here) ...
                try {
                    const response = await fetch(`${this.baseUrl}/models?key=${apiKey}`);
                    if (!response.ok) return [];
                    const data = await response.json();
                    return data.models.filter(m => 
                        m.name.includes('gemini') && 
                        m.supportedGenerationMethods && 
                        m.supportedGenerationMethods.includes('generateContent')
                    );
                } catch (e) {
                    console.error("Failed to fetch models", e);
                    return [];
                }
            },

            async generate(apiKey, model, systemPrompt, userPrompt) {
                // FIX: Ensure we don't duplicate 'models/' in the URL
                // The 'model' variable comes from listModels as 'models/gemini-xyz'
                const cleanModel = model.startsWith('models/') ? model : `models/${model}`;
                
                const url = `${this.baseUrl}/${cleanModel}:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: systemPrompt },
                            { text: userPrompt }
                        ]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: this.schema
                    }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`AI Request failed (${response.status}): ${errorBody}`);
                }
                
                const data = await response.json();
                
                try {
                    const text = data.candidates[0].content.parts[0].text;
                    const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    return JSON.parse(jsonStr);
                } catch (e) {
                    throw new Error('Failed to parse AI response');
                }
            }
        };

        /**
         * Application State & Logic
         */
        const App = {
            state: {
                config: { githubToken: '', aiApiKey: '', githubRepo: '', preferredModel: '' },
                projects: [],
                projectHistory: {},
                projectToDelete: null,
                currentProject: null,
                fileData: { content: '', sha: '', pendingContent: '', commitMsg: '', lastAiResponseJson: null },
                isLoading: false
            },
            
            STORAGE_KEY_CONFIG: 'webcoder_config',
            STORAGE_KEY_HISTORY: 'webcoder_history',

            init() { this.loadState(); this.router(); this.bindEvents(); },
            loadState() {
                const c = localStorage.getItem(this.STORAGE_KEY_CONFIG);
                if(c) this.state.config = JSON.parse(c);
                const h = localStorage.getItem(this.STORAGE_KEY_HISTORY);
                if(h) this.state.projectHistory = JSON.parse(h);
            },
            router() { /* ... same as before ... */ 
                if (!this.state.config.githubToken) this.navigateTo('setup');
                else {
                     const hash = window.location.hash.replace('#', '');
                     if(hash === 'setup') this.navigateTo('setup');
                     else this.navigateTo('projects');
                }
            },
            
            saveConfig() { /* ... same ... */ 
                localStorage.setItem(this.STORAGE_KEY_CONFIG, JSON.stringify(this.state.config));
                this.navigateTo('projects');
            },
            saveProjects() { /* ... same ... */ 
                localStorage.setItem(this.STORAGE_KEY_PROJECTS, JSON.stringify(this.state.projects));
            },

            navigateTo(screenId) {
                // Toggle Global Header based on screen
                const globalHeader = document.querySelector('body > .app-header');
                if (screenId === 'editor') {
                    globalHeader.style.display = 'none';
                } else {
                    globalHeader.style.display = 'flex';
                }

                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                const target = document.getElementById(`screen-${screenId}`);
                if (target) {
                    target.classList.add('active');
                    this.onViewEnter(screenId);
                }
            },

            async onViewEnter(screenId) {
                if (screenId === 'projects') this.renderProjects();
                if (screenId === 'setup') {
                    document.getElementById('gh-token').value = this.state.config.githubToken || '';
                    document.getElementById('gh-repo').value = this.state.config.githubRepo || '';
                    document.getElementById('ai-key').value = this.state.config.aiApiKey || '';
                }
            },
            
            // ... [Previous renderProjects, addProject, deleteProject methods remain same] ...
            async renderProjects() {
                 const container = document.getElementById('project-list-container');
                 const emptyState = document.getElementById('empty-state');
                 if (!this.state.config.githubRepo || !this.state.config.githubToken) {
                    container.innerHTML = '<div style="text-align:center; padding: 20px;">Please configure your GitHub settings first.</div>';
                    return;
                 }
                 container.innerHTML = '<div style="text-align:center; padding: 20px;"><span class="spinner"></span> Loading projects from repository...</div>';
                 try {
                    const [owner, repo] = this.state.config.githubRepo.split('/');
                    const items = await GitHubAPI.getContents(this.state.config.githubToken, owner, repo);
                    const projects = items.filter(i => i.type === 'dir');
                    container.innerHTML = '';
                    if (projects.length === 0) emptyState.classList.remove('hidden');
                    else {
                        emptyState.classList.add('hidden');
                        projects.forEach(proj => {
                            const div = document.createElement('div');
                            div.className = 'project-card';
                            div.innerHTML = `<div class="project-info"><h3>${this.escapeHtml(proj.name)}</h3><p>${owner}/${repo}/${proj.name}</p></div><div class="project-actions"><button class="icon-btn" onclick="App.openEditor('${proj.name}')">‚úèÔ∏è</button><button class="icon-btn danger" onclick="App.confirmDelete('${proj.name}')">üóëÔ∏è</button></div>`;
                            container.appendChild(div);
                        });
                    }
                 } catch (e) { container.innerHTML = `<div style="color: var(--danger-color); padding: 20px;">Error: ${e.message}</div>`; }
            },
            async addProject(name) {
                try {
                    const [owner, repo] = this.state.config.githubRepo.split('/');
                    const path = `${name}/index.html`;
                    const template = `<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>${name}</title>\n</head>\n<body>\n  <h1>${name}</h1>\n</body>\n</html>`;
                    await GitHubAPI.updateFile(this.state.config.githubToken, owner, repo, path, template, null, `Initialize project: ${name}`);
                    this.closeModals(); await this.renderProjects(); this.showToast("Project created.");
                } catch(e) { this.showToast("Creation failed: " + e.message); }
            },
            confirmDelete(name) { this.state.projectToDelete = name; this.openModal('modal-delete-confirm'); },
            async deleteProject() { 
                const btn = document.getElementById('btn-confirm-delete');
                const originalText = btn.textContent; try {
                    btn.textContent = "Deleting..."; btn.disabled = true;
                    const [owner, repo] = this.state.config.githubRepo.split('/');
                    const path = `${this.state.projectToDelete}/index.html`;
                    const file = await GitHubAPI.getFile(this.state.config.githubToken, owner, repo, path);
                    if (!file.sha) throw new Error("index.html not found");
                    await GitHubAPI.deleteFile(this.state.config.githubToken, owner, repo, path, file.sha, `Delete project: ${this.state.projectToDelete}`);
                    this.closeModals(); await this.renderProjects(); this.showToast("Project deleted.");
                } catch (e) { this.showToast("Delete failed: " + e.message); } finally { btn.textContent = originalText; btn.disabled = false; }
            },

            /* --- Editor Logic --- */

            async openEditor(name) {
                const [owner, repo] = this.state.config.githubRepo.split('/');
                const path = `${name}/index.html`;
                this.state.currentProject = { id: name, name, repoOwner: owner, repoName: repo, filePath: path };
                this.state.fileData = { content: '', sha: '', pendingContent: '', commitMsg: '' };
                document.getElementById('editor-title').textContent = name;
                const chatContainer = document.getElementById('chat-history');
                chatContainer.innerHTML = '';
                const history = this.state.projectHistory[name] || [];
                if (history.length === 0) chatContainer.innerHTML = '<div class="message system">Loading latest file from GitHub...</div>';
                else history.forEach(msg => this.renderChatMessage(msg));
                document.getElementById('preview-frame').srcdoc = '';
                this.navigateTo('editor'); this.switchTab('ai'); this.loadModels();
                try {
                    const data = await GitHubAPI.getFile(this.state.config.githubToken, owner, repo, path);
                    this.state.fileData.content = data.content; this.state.fileData.pendingContent = data.content; this.state.fileData.sha = data.sha;
                    if (data.sha === null) this.addChatMessage('system', 'File not found on GitHub. Using new template.');
                    else this.addChatMessage('system', 'File loaded. Ready.');
                    this.updatePreview();
                } catch (e) { this.addChatMessage('system', 'Error: ' + e.message); }
            },

            async loadModels() {
                // NOTE: Dynamic model loading is disabled to use the hardcoded list in index.html.
                const select = document.getElementById('model-select');

                // Restore preference
                if (this.state.config.preferredModel) {
                    // Check if the preferred model is in the list, otherwise select first
                    if (Array.from(select.options).some(o => o.value === this.state.config.preferredModel)) {
                        select.value = this.state.config.preferredModel;
                    }
                }
            },

            switchTab(tabName) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                const buttons = document.querySelectorAll('.tab-btn');
                if(tabName === 'ai') buttons[0].classList.add('active');
                if(tabName === 'preview') {
                    buttons[1].classList.add('active');
                    this.updatePreview(); 
                }
                if(tabName === 'manual') {
                    buttons[2].classList.add('active');
                    // Sync Manual Editor with current state (AI might have changed it)
                    this.updateManualEditor(); 
                }
                
                document.getElementById(`tab-${tabName}`).classList.add('active');
            },

            updatePreview() {
                const frame = document.getElementById('preview-frame');
                // Use pending content if changes exist, otherwise original
                frame.srcdoc = this.state.fileData.pendingContent || this.state.fileData.content;
            },

            updateManualEditor() {
                const textarea = document.getElementById('manual-code-area');
                // Only update value if it differs to prevent cursor jumping if already focused
                if (textarea.value !== this.state.fileData.pendingContent) {
                    textarea.value = this.state.fileData.pendingContent || '';
                }
                this.renderLineNumbers();
            },

            renderLineNumbers() {
                const textarea = document.getElementById('manual-code-area');
                const lineNumbersEle = document.getElementById('line-numbers');
                const lines = textarea.value.split('\n').length;
                
                // Optimized: only rebuild if line count changes significantly
                if (lineNumbersEle.childElementCount !== lines) {
                    lineNumbersEle.innerHTML = Array(lines).fill(0).map((_, i) => `<div>${i + 1}</div>`).join('');
                }
            },
            
            handleManualInput(e) {
                const text = e.target.value;
                this.state.fileData.pendingContent = text;
                // If user edits manually, reset the AI commit message suggestion or keep generic
                if (!this.state.fileData.commitMsg) {
                    this.state.fileData.commitMsg = "Manual update to index.html";
                }
                this.renderLineNumbers();
            },

            async sendPrompt() {
                if (this.state.isLoading) return;
                
                const input = document.getElementById('ai-prompt');
                const userText = input.value.trim();
                const model = document.getElementById('model-select').value;
                if (!userText) return;

                this.persistChatMessage(this.state.currentProject.id, { role: 'user', text: userText });
                input.value = '';
                this.state.isLoading = true;
                const loadingMsgId = this.addChatMessage('system', 'AI is coding... <span class="spinner"></span>');

                try {
                    const preChangeContent = this.state.fileData.pendingContent;
                    const systemPrompt = `
                        You are a professional web developer.
                        TARGET FILE: ${this.state.currentProject.filePath}
                        CURRENT CONTENT: 
                        ${this.state.fileData.pendingContent}
                        INSTRUCTIONS:
                        1. Analyze the User Request and the Current Content.
                        2. Generate a list of search/replace operations to fulfill the request.
                        3. Ensure 'search_string' is unique enough to match only the intended lines.
                        4. Ensure 'replacement_string' contains the full new code block.
                        5. HARD REQUIREMENT: The entire web application must be contained within this single 'index.html' file. This includes all HTML, CSS, and JavaScript. Do not suggest or use any external libraries or files.
                    `;

                    const result = await GoogleAI.generate(this.state.config.aiApiKey, model, systemPrompt, userText);
                    
                    // Give each operation a unique ID for tracking
                    if (result.operations) {
                        result.operations.forEach((op, index) => op.id = `op-${Date.now()}-${index}`);
                    }
                    
                    this.state.fileData.commitMsg = result.commit_message;
                    this.state.fileData.lastAiResponseJson = result;

                    document.getElementById(loadingMsgId).remove();

                    const aiMsgContent = `
                        <div class="diff-summary">
                            <strong>${result.commit_message || 'AI Response Received'}</strong><br>
                            AI generated ${result.operations?.length || 0} change(s).
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-primary" onclick="App.showReviewModal(this)" style="font-size:0.8rem; padding:8px;">Review Changes</button>
                        </div>
                    `;

                    this.persistChatMessage(this.state.currentProject.id, { 
                        role: 'ai', 
                        text: aiMsgContent, 
                        snapshot: preChangeContent,
                        aiResponse: this.state.fileData.lastAiResponseJson
                    });

                } catch (e) {
                    document.getElementById(loadingMsgId).textContent = "Error: " + e.message;
                } finally {
                    this.state.isLoading = false;
                }
            },

            // Save to localStorage, render, and trim history if needed.
            persistChatMessage(projectId, msgObj) {
                if (!this.state.projectHistory[projectId]) this.state.projectHistory[projectId] = [];
                
                msgObj.id = Date.now().toString();
                msgObj.timestamp = Date.now();
                
                let projectHistory = this.state.projectHistory[projectId];
                projectHistory.push(msgObj);

                let wasTrimmed = false;
                // Trim history only when an AI message is added, representing the end of a "turn".
                if (msgObj.role === 'ai') {
                    const historyLimit = 5; // 5 prompts and outputs
                    const userMessageIndices = projectHistory
                        .map((msg, index) => msg.role === 'user' ? index : -1)
                        .filter(index => index !== -1);

                    if (userMessageIndices.length > historyLimit) {
                        const amountToTrim = userMessageIndices.length - historyLimit;
                        const cutOffIndex = userMessageIndices[amountToTrim];
                        
                        const newHistory = projectHistory.slice(cutOffIndex);
                        this.state.projectHistory[projectId] = newHistory;
                        projectHistory = newHistory; // Also update the local variable for re-rendering
                        wasTrimmed = true;
                    }
                }
                
                localStorage.setItem(this.STORAGE_KEY_HISTORY, JSON.stringify(this.state.projectHistory));
                
                if (wasTrimmed) {
                    // Re-render entire chat history if it was trimmed
                    const chatContainer = document.getElementById('chat-history');
                    chatContainer.innerHTML = '';
                    projectHistory.forEach(msg => this.renderChatMessage(msg));
                    
                    // The function is expected to return the ID of the rendered message.
                    // Since we re-rendered, the last one is the one we just added.
                    return projectHistory[projectHistory.length - 1]?.id;
                } else {
                    // No trimming, just render the single new message as before
                    return this.renderChatMessage(msgObj);
                }
            },

            // Render to DOM (used by loadState and persistChatMessage)
            renderChatMessage(msgObj) {
                return this.addChatMessage(msgObj.role, msgObj.text, msgObj.snapshot, msgObj.id);
            },

            // Low level DOM append
            addChatMessage(type, html, snapshot = null, id = null) {
                const div = document.createElement('div');
                div.className = `message ${type}`;
                div.id = id || 'msg-' + Date.now();
                div.innerHTML = html;
                
                if (snapshot && type === 'ai') {
                    const actionDiv = document.createElement('div');
                    actionDiv.className = 'message-actions';
                    actionDiv.innerHTML = `<button class="btn-xs" onclick="App.undoChange('${div.id}')">‚Ü∫ Undo Changes</button>`;
                    div.appendChild(actionDiv);
                }

                const container = document.getElementById('chat-history');
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
                return div.id;
            },

            undoChange(msgId) {
                const projectId = this.state.currentProject.id;
                const history = this.state.projectHistory[projectId];
                const msgIndex = history.findIndex(m => m.id === msgId);
                
                if (msgIndex === -1) return;
                
                const msg = history[msgIndex];
                if (!msg.snapshot) return this.showToast("No restore point found.");

                this.state.fileData.pendingContent = msg.snapshot;
                this.updatePreview();
                this.updateManualEditor();
                
                this.showToast("Changes reverted to state before this prompt.");
                this.addChatMessage('system', '‚Ü∫ Reverted code to previous state.');

                delete history[msgIndex].snapshot;
                localStorage.setItem(this.STORAGE_KEY_HISTORY, JSON.stringify(this.state.projectHistory));
                
                const btn = document.querySelector(`#${msgId} .btn-xs`);
                if(btn) btn.remove();
            },

            renderReviewModalContent(operations) {
                const listContainer = document.getElementById('review-operations-list');
                listContainer.innerHTML = '';
                const currentContent = this.state.fileData.pendingContent;

                operations.forEach((op, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'operation-item';
                    const isApplied = op.applied;
                    const canApply = !isApplied && currentContent.includes(op.search_string);

                    itemDiv.innerHTML = `
                        <div class="operation-header">
                            ${!isApplied ? `
                                <input type="checkbox" id="op-checkbox-${op.id}" data-op-index="${index}" ${canApply ? 'checked' : 'disabled'}>
                                <label for="op-checkbox-${op.id}">
                                    ${canApply ? 'Apply this change' : '<span style="color: var(--danger-color)">‚ö†Ô∏è Match not found</span>'}
                                </label>
                                ${!canApply ? `<button type="button" class="btn-xs" style="margin-left: 10px; cursor: pointer;" onclick="App.openManualSelectModal(${index})">Select Lines Manually</button>` : ''}
                            ` : `
                                <span>‚úÖ Applied</span>
                                <button class="btn-xs" onclick="App.revertChange(${index})">Revert</button>
                            `}
                        </div>
                        <div class="diff-view">
                            <pre class="removed">- ${this.escapeHtml(op.search_string)}</pre>
                            <pre class="added">+ ${this.escapeHtml(op.replacement_string)}</pre>
                        </div>
                    `;
                    listContainer.appendChild(itemDiv);
                });

                const applyBtn = document.getElementById('btn-apply-selected');
                if (operations.every(op => op.applied)) {
                    applyBtn.style.display = 'none';
                } else {
                    applyBtn.style.display = 'block';
                }
            },

            showReviewModal(buttonElement) {
                const messageDiv = buttonElement.closest('.message');
                if (!messageDiv) return;

                const msgId = messageDiv.id;
                this.state.fileData.reviewingMessageId = msgId;

                const projectId = this.state.currentProject.id;
                const history = this.state.projectHistory[projectId] || [];
                const msg = history.find(m => m.id === msgId);

                const operations = msg?.aiResponse?.operations;
                if (!operations) {
                    this.showToast("No AI output available to review.");
                    return;
                }

                this.renderReviewModalContent(operations);
                this.openModal('modal-review');
            },
            
            applySelectedChanges() {
                const msgId = this.state.fileData.reviewingMessageId;
                if (!msgId) return;

                const projectId = this.state.currentProject.id;
                const history = this.state.projectHistory[projectId] || [];
                const msg = history.find(m => m.id === msgId);
                
                if (!msg || !msg.aiResponse) return;

                const operations = msg.aiResponse.operations;
                let newContent = this.state.fileData.pendingContent;
                let successCount = 0;

                const checkboxes = document.querySelectorAll('#review-operations-list input[type="checkbox"]:checked');
                
                checkboxes.forEach(cb => {
                    const opIndex = parseInt(cb.dataset.opIndex, 10);
                    const op = operations[opIndex];

                    if (!op.applied && newContent.includes(op.search_string)) {
                        newContent = newContent.replace(op.search_string, op.replacement_string);
                        op.applied = true; // This modifies the object in history
                        successCount++;
                    } else if (!op.applied) {
                        this.showToast("Could not apply a change, code may have been modified.", "error");
                    }
                });

                if (successCount > 0) {
                    localStorage.setItem(this.STORAGE_KEY_HISTORY, JSON.stringify(this.state.projectHistory));
                    this.state.fileData.pendingContent = newContent;
                    this.updatePreview();
                    this.updateManualEditor();
                    this.showToast(`${successCount} change(s) applied.`);
                }
                
                this.closeModals();
            },

            revertChange(opIndex) {
                const msgId = this.state.fileData.reviewingMessageId;
                if (!msgId) return;

                const projectId = this.state.currentProject.id;
                const history = this.state.projectHistory[projectId] || [];
                const msg = history.find(m => m.id === msgId);
                
                if (!msg || !msg.aiResponse) return;

                const op = msg.aiResponse.operations[opIndex];
                if (!op || !op.applied) return;

                let currentContent = this.state.fileData.pendingContent;

                if (currentContent.includes(op.replacement_string)) {
                    currentContent = currentContent.replace(op.replacement_string, op.search_string);
                    delete op.applied; // This modifies the object in history
                    localStorage.setItem(this.STORAGE_KEY_HISTORY, JSON.stringify(this.state.projectHistory));

                    this.state.fileData.pendingContent = currentContent;
                    this.updatePreview();
                    this.updateManualEditor();
                    this.showToast("Change reverted.");

                    this.renderReviewModalContent(msg.aiResponse.operations); 
                } else {
                    this.showToast("Could not revert: code block not found.");
                }
            },

            /* --- Commit Logic --- */

            openCommitModal() {
                if (this.state.fileData.pendingContent === this.state.fileData.content) {
                    this.showToast("No changes to commit.");
                    return;
                }
                document.getElementById('commit-msg').value = this.state.fileData.commitMsg || "Update index.html";
                this.openModal('modal-commit');
            },

            async commitChanges() {
                const btn = document.getElementById('btn-push');
                const msg = document.getElementById('commit-msg').value;
                const originalText = btn.textContent;
                
                try {
                    btn.textContent = "Pushing...";
                    btn.disabled = true;

                    const res = await GitHubAPI.updateFile(
                        this.state.config.githubToken,
                        this.state.currentProject.repoOwner,
                        this.state.currentProject.repoName,
                        this.state.currentProject.filePath,
                        this.state.fileData.pendingContent,
                        this.state.fileData.sha,
                        msg
                    );

                    this.state.fileData.sha = res.content.sha;
                    this.state.fileData.content = this.state.fileData.pendingContent;
                    
                    this.closeModals();
                    this.showToast("Changes pushed successfully!");
                    this.addChatMessage('system', '‚úÖ Changes committed to GitHub.');

                } catch (e) {
                    this.showToast("Commit failed: " + e.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            },

            // ... [Previous Modal utilities & Helper methods] ...
            openModal(id) { document.getElementById(id).classList.add('open'); },
            closeModals() { 
                document.querySelectorAll('.modal-overlay').forEach(e => e.classList.remove('open')); 
                this.state.projectToDelete=null; 
                if (this.state.fileData) {
                    this.state.fileData.reviewingMessageId = null;
                    this.state.fileData.manualSelectOpIndex = null;
                }
            },
            
            closeManualSelect() {
                document.getElementById('modal-manual-select').classList.remove('open');
                this.state.fileData.manualSelectOpIndex = null;
            },

            openManualSelectModal(opIndex) {
                this.state.fileData.manualSelectOpIndex = opIndex;
                this.state.fileData.manualSelectedLines = new Set();
                
                const msgId = this.state.fileData.reviewingMessageId;
                const projectId = this.state.currentProject.id;
                const history = this.state.projectHistory[projectId] || [];
                const msg = history.find(m => m.id === msgId);
                const op = msg.aiResponse.operations[opIndex];

                document.getElementById('manual-ai-search-view').textContent = op.search_string;
                document.getElementById('manual-ai-replace-view').textContent = op.replacement_string;
                
                document.getElementById('btn-apply-manual').disabled = true;
                document.getElementById('selection-status').textContent = "Click lines to select";
                document.getElementById('manual-line-search').value = "";

                this.renderManualLines();
                this.openModal('modal-manual-select');
            },

            renderManualLines(filter = "") {
                const container = document.getElementById('manual-line-navigator');
                container.innerHTML = '';
                const lines = this.state.fileData.pendingContent.split('\n');
                const selected = this.state.fileData.manualSelectedLines;

                lines.forEach((text, i) => {
                    const isSelected = selected.has(i);
                    const isMatch = filter && text.toLowerCase().includes(filter.toLowerCase());
                    
                    const row = document.createElement('div');
                    row.className = `line-row ${isSelected ? 'selected' : ''} ${isMatch ? 'match' : ''}`;
                    row.innerHTML = `
                        <div class="line-num-nav">${i + 1}</div>
                        <div class="line-content-nav">${this.escapeHtml(text || ' ')}</div>
                    `;
                    row.onclick = () => this.handleManualLineClick(i);
                    container.appendChild(row);
                    
                    if (isMatch && filter && !this._scrolledToFirstMatch) {
                        row.scrollIntoView({ block: 'start' });
                        this._scrolledToFirstMatch = true;
                    }
                });
            },

            handleManualLineClick(index) {
                const selected = this.state.fileData.manualSelectedLines;
                if (selected.has(index)) selected.delete(index);
                else selected.add(index);
                
                const count = selected.size;
                document.getElementById('btn-apply-manual').disabled = count === 0;
                document.getElementById('selection-status').textContent = count === 0 ? "Click lines to select" : `${count} line(s) selected`;
                this.renderManualLines(document.getElementById('manual-line-search').value);
            },

            applyManualChange() {
                const selected = this.state.fileData.manualSelectedLines;
                if (selected.size === 0) return;
                
                const opIndex = this.state.fileData.manualSelectOpIndex;
                const msgId = this.state.fileData.reviewingMessageId;
                
                const projectId = this.state.currentProject.id;
                const history = this.state.projectHistory[projectId] || [];
                const msg = history.find(m => m.id === msgId);
                const op = msg.aiResponse.operations[opIndex];

                const lines = this.state.fileData.pendingContent.split('\n');
                const firstIdx = Math.min(...selected);
                
                const newLines = [];
                for (let i = 0; i < lines.length; i++) {
                    if (i === firstIdx) {
                        newLines.push(op.replacement_string);
                    } else if (!selected.has(i)) {
                        newLines.push(lines[i]);
                    }
                }
                
                this.state.fileData.pendingContent = newLines.join('\n');
                op.applied = true;
                localStorage.setItem(this.STORAGE_KEY_HISTORY, JSON.stringify(this.state.projectHistory));
                
                this.updatePreview();
                this.updateManualEditor();
                this.closeManualSelect();
                this.renderReviewModalContent(msg.aiResponse.operations);
                this.showToast("Manual replacement applied.");
            },
            escapeHtml(t) { return t.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); },
            showToast(m) {
                const c = document.getElementById('toast-container'); const t = document.createElement('div');
                t.className='toast'; t.textContent=m; c.appendChild(t); void t.offsetWidth; t.classList.add('show');
                setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300)},3000);
            },
            /* --- Event Bindings --- */
            bindEvents() {
                const setupForm = document.getElementById('setup-form');
                if(setupForm) setupForm.addEventListener('submit', (e)=>{e.preventDefault(); 
                    const t=document.getElementById('gh-token').value.trim(), k=document.getElementById('ai-key').value.trim(), r=document.getElementById('gh-repo').value.trim();
                    if(!t||!k||!r)return this.showToast("All configuration fields are required");
                    this.state.config={githubToken:t,aiApiKey:k,githubRepo:r}; this.saveConfig();
                });
                document.getElementById('btn-settings').onclick = ()=>this.navigateTo('setup');
                document.getElementById('btn-add-project').onclick = ()=>this.openModal('modal-add-project');
                document.getElementById('btn-import-export').onclick = ()=>this.openModal('modal-io');
                document.getElementById('form-add-project').addEventListener('submit',(e)=>{e.preventDefault();
                    this.addProject(document.getElementById('inp-proj-name').value);
                });
                document.getElementById('btn-confirm-delete').onclick = ()=>this.deleteProject();
                document.getElementById('btn-download-json').onclick = () => this.exportProjects();
                document.getElementById('inp-import-json').onchange = (e) => {if(e.target.files.length) this.importProjects(e.target.files[0])};

                // NEW Editor Bindings
                document.getElementById('btn-send-prompt').onclick = () => this.sendPrompt();
                document.getElementById('btn-save-trigger').onclick = () => this.openCommitModal();
                document.getElementById('form-commit').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.commitChanges();
                });
                document.getElementById('btn-apply-selected').onclick = () => this.applySelectedChanges();
                document.getElementById('btn-apply-manual').onclick = () => this.applyManualChange();

                document.getElementById('manual-line-search').addEventListener('input', (e) => {
                    this._scrolledToFirstMatch = false;
                    this.renderManualLines(e.target.value);
                });

                // NEW: Model Selector Change
                document.getElementById('model-select').addEventListener('change', (e) => {
                    this.state.config.preferredModel = e.target.value;
                    // Silent save to local storage without navigation
                    localStorage.setItem(this.STORAGE_KEY_CONFIG, JSON.stringify(this.state.config));
                });

                // Manual Editor Bindings
                const codeArea = document.getElementById('manual-code-area');
                
                // 1. Sync content and line numbers on typing
                codeArea.addEventListener('input', (e) => this.handleManualInput(e));
                
                // 2. Sync Scroll (Vertical) between textarea and line numbers
                codeArea.addEventListener('scroll', (e) => {
                    document.getElementById('line-numbers').scrollTop = e.target.scrollTop;
                });

                // 3. Enable Tab Key (Insert 2 spaces)
                codeArea.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        const start = codeArea.selectionStart;
                        const end = codeArea.selectionEnd;
                        
                        // Insert 2 spaces
                        codeArea.value = codeArea.value.substring(0, start) + "  " + codeArea.value.substring(end);
                        
                        // Move cursor
                        codeArea.selectionStart = codeArea.selectionEnd = start + 2;
                        
                        // Update state immediately
                        this.handleManualInput({ target: codeArea });
                    }
                });
            },
            
            // Re-adding import/export helpers missed in copy paste logic
            exportProjects() {
                const b = new Blob([JSON.stringify(this.state.projects,null,2)],{type:'application/json'});
                const u = URL.createObjectURL(b), a=document.createElement('a'); a.href=u; a.download='webcoder.json'; a.click();
            },
            importProjects(f) {
                const r = new FileReader(); r.onload=e=>{
                    try { this.state.projects=JSON.parse(e.target.result); this.saveProjects(); this.closeModals(); this.showToast("Imported"); }
                    catch(x){ this.showToast("Bad JSON");}
                }; r.readAsText(f);
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>